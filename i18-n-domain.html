<!--
@license
Copyright (c) 2015 Peter Kaske <p.kaske@gmail.com>. All rights reserved.
This code may only be used under the MIT license found at http://opensource.org/licenses/MIT.
Or see the LICENSE file that comes with this code.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<!--
# <i18-n-domain>
These elements were heavily inspired by the `<i18n-msg>` element, written by [ebidel](https://github.com/ebidel/i18n-msg).

The system consists of two elements working together: `<i18-n>` and `<i18-n-domain>`

You need at least one `<i18-n-domain>` in your document. It loads the locale file via `<iron-ajax>` and fills a `I18nCache` global with the translation strings.
As the name suggests, this element also provides a language domain (named `default` if no other was set).

`<i18-n>` elements can define a language domain they belong to and will only be filled with translation string from that domain.

The domain element provides some public methods to get translation strings.

<strong>Notes:</strong>
  - Locale files are only fetched once, unless the http request fails with code other than 404.
  - If the fetch fails, will fallback to a first successfully loaded locale.

Locale files of the `default` domain must use the locale as the filename:
`lang/en.json`, `lang/de.json`, `lang/fr.json`

Locale files of any domain other than `default` must prepend the domain name followed by a `-`:

"`lang/mydomain-en.json`", "`lang/mydomain-de.json`" or "`lang/mydomain-fr.json`"

### Example of a locale file

```json
{
  "welcome-text": {
    "description": "some description for internal use (optional)",
    "message": "Welcome!"
  },
  "goodbye-text": {
    "message": "Goodbye!"
  },
  "no-description-text": "You may use a more concise syntax like this, but it won't be compatible with Chrome's messages.json (see https://developer.chrome.com/extensions/i18n-messages)"
}
```

## Example
See the comments on the `<i18-n>` element for a simple example.

@element i18-n-domain
@demo demo/index.html
@homepage https://pkaske.github.io/i18-n
-->
<dom-module id="i18-n-domain">
  <template>
    <iron-ajax id="ajax"
               url="{{messagesUrl}}"
               handle-as="json"
               on-response="_handleResponse"
               on-error="_handleError"></iron-ajax>
  </template>
</dom-module>
<script>
  (function () {

    /**
     * The global cache for all locales loaded.
     */
    window.I18nCache = window.I18nCache || { domains: {} };

    Polymer({
      is: 'i18-n-domain',

      /**
       * The `i18-n-locale-ready` is fired after the locale was fetched and all `<i18n-msg>` elements were updated.
       *
       * @event i18-n-locale-ready
       * @detail {{domain: String, locale: String}}
       */

     /**
      * The `i18-n-locale-fallback` is fired after locale has failed to fetch.
      *
      * @event i18-n-locale-fallback
      * @detail {{domain: String, locale: String, fallbackLocale: String, httpCode: Number}}
      */

      properties: {
        /**
         * The domain the element serves.
         */
        domain: {
          type: String,
          value: 'default',
          observer: '_domainChanged'
        },

        /**
         * The default locale being used.
         */
        locale: {
          type: String,
          notify: true
        },

        /**
         * The folder name where the localized `<lang>.json` files are located.
         */
        messagesUrl: {
          type: String,
          value: 'lang',
          observer: '_messagesUrlChanged'
        },

        /**
         * Reference to the global `I18nCache.domains` object
         */
        domains: {
          type: Object,
          value: function() { return window.I18nCache.domains; },
          readOnly: true,
          observer: '_domainsChanged'
        }
      },

      detached: function() {
        // Once detached noone should use `this`
        var elements = this.domains[this.domain].domainElements;
        elements.splice(elements.indexOf(this), 1);
      },

      observers: [
        '_shouldFetch(locale, messagesUrl)'
      ],

      /**
       * Returns a message in the chosen locale and domain.
       * @method getMsg
       * @param {string} msgId Message id for translation string lookup.
       * @param {string} [locale=this.locale] Locale to use for lookup.
       * @param {string} [domain=this.domain] Language domain to use for lookup.
       * @return {string|null} Translated message or `null` if not found.
       */
      getMsg: function(msgId, locale, domain) {
        domain = domain || this.domain;
        locale = locale || this.locale;

        if (!this.domains[domain] || !this.domains[domain].locales[locale]) {
          return null;
        }

        var lang = this.domains[domain].locales[locale];
        if (lang[msgId]) {
          if (lang[msgId].message == undefined) {
            if (typeof lang[msgId] === 'string')
              lang[msgId] = {message:lang[msgId]};
            else return null;
          }
          return lang[msgId].message;

        }
        return null;
      },

      /**
       * Returns all messages of a locale.
       * @method getLocale
       * @param {string} [locale=this.locale] Locale to use for lookup.
       * @param {string} [domain=this.domain] Language domain to use for lookup.
       * @return {Object|null} Object holding the translated messages or `null` if not found.
       */
      getLocale: function(locale, domain) {
        domain = domain || this.domain;
        locale = locale || this.locale;

        if (!this.domains[domain] || !this.domains[domain].locales[locale]) {
          return null;
        }

        return this.domains[domain].locales[locale];
      },

      /**
       * Only fetch if a locale, location
       */
      _shouldFetch: function(newLocale, messagesUrl) {
        if (this.getLocale(newLocale) != null) {
          this.domains[this.domain].activeLocale = newLocale;
          this._updateInstances(newLocale);
          this.fire('i18-n-locale-ready', { 'domain': this.domain, 'locale': newLocale });
          return;
        }

        this.async(function() {
          this._fetchLocale(newLocale);
        });
      },

      /**
       * Fetch locale file after the messages url was changed.
       */
      _messagesUrlChanged: function(newUrl, oldUrl) {
        if (oldUrl) {
          this.async(function () {
            // Forced fetch of the locale file.
            this._fetchLocale(this.locale, true);
          });
        }
      },

      _domainChanged: function(newDomain, oldDomain) {
        if (oldDomain) throw new Error('Cannot change domain of <i18-n-domain>')
        this._registerGlobal(newDomain, this.domains);
      },
      _domainsChanged: function(newDomains) { this._registerGlobal(this.domain, newDomains); },
      _registerGlobal: function(domain, domains) {
        // _registerGlobal is called when either of those changes.
        // They could be initialized in any order.
        if (!domain || !domains) return;

        // Initiate or get the domain object.
        if (domains[domain]) {
          // Track currently attached `i18-n-domain` element.
          if (!domains[domain].domainElements) {
            domains[domain].domainElements = [];
          }
          domains[domain].domainElements.push(this);
        } else {
          domains[domain] = {
            locales: {},
            instances: [],
            domainElements: [this]
          };
        }
      },

      /**
       * Uses `iron-ajax` to fetch the locale file.
       */
      _fetchLocale: function(locale, force) {
        if (!locale) return;
        if (this.getLocale(locale) != null && force !== true) {
          return; // Don't fetch if the locale is already defined in the global object.
        }

        // Set the locale we're about to fetch. This prevents duplicate requests by other `i18-n-domain` elements.
        this.domains[this.domain].locales[locale] = {};

        var domain = this.domain != 'default' ? this.domain + '-' : '';
        var url = this.messagesUrl + '/' + domain + locale + '.json';
        this.$.ajax.url = url;
        var request = this.$.ajax.generateRequest();
        request.locale = locale;
      },

      /**
       * Add the fetched locale to the `I18nCache` global and update instances.
       */
      _handleResponse: function(response) {
        var locale = response.detail.locale;

        /**
         * Save initial locale choice and assume it's a preferred locale
         * in case some other locale can't be loaded.
         */
        if (!this._preferredLocale) this._preferredLocale = locale;
        this.domains[this.domain].locales[locale] = response.detail.response;
        this.domains[this.domain].activeLocale = locale;
        this._updateInstances(locale);

        this.fire('i18-n-locale-ready', { 'domain': this.domain, 'locale': locale });
      },

      /**
       * Handle 404, connection error etc.
       * Fallback to the first loaded locale if possible.
       */
      _handleError: function(response) {
        var locales = this.domains[this.domain].locales,
            status = response.detail.request.status,
            requestedLocale;

        // Find requested locale (the one previously set locale = {})
        for (var locale in locales) {
          if (Object.keys(locales[locale]).length == 0) {
            requestedLocale = locale;
          }
        }

        var keys = Object.keys(locales);
        if (keys.length == 1) {
          // No other locales available.
          // Just keep the placeholders and reset preferred locale.
          delete locales[keys[0]];
          delete this._preferredLocale;
        } else {
          if (status != 404) {
            // Allow locale reload.
            // For now fallback to preferred locale.
            delete locales[requestedLocale];
            this.locale = this._preferredLocale;
          } else {
            // Do not allow to reload later since the locale file doesn't exist.
            // Make a permanent fallback by reusing fallback locale object.
            locales[requestedLocale] = locales[this._preferredLocale];
            this._updateInstances(locale);
          }
        }

        this.fire('i18-n-locale-fallback', {
          domain: this.domain,
          locale: requestedLocale,
          fallbackLocale: this._preferredLocale,
          httpCode: status
        });
      },

      /**
       * Notify all `<i18-n>` instances of a particular language domain that they should update themselfs.
       */
      _updateInstances: function(locale) {
        var instances = this.domains[this.domain].instances;
        for (var i = 0, instance; instance = instances[i]; ++i) {
          instance.update(locale);
        }
      }
    });
  })();
</script>
